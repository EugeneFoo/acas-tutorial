from django.db import models
from django.conf import settings
import secrets

try:
    IDLENGTH = settings.ID_TEXT_LENGTH

    # Minimum length for random string is 18-byte
    if IDLENGTH < 18:
        IDLENGTH = 18
except:
    # Default length for random string is 32-byte
    IDLENGTH = 32


def generate_random_id():
    return secrets.token_urlsafe(IDLENGTH)[:IDLENGTH]


class RandomIDModel(models.Model):
    """Provides a model base that transparently generates a random string with 
    IDLENGTH length as its primary key, which is robust to collisions.
    """

    class Meta:
        abstract = True

    id = models.CharField(max_length=IDLENGTH, primary_key=True)

    def save(self, *args, **kwargs):
        """If the user hasn't provided an ID, generate one at random and check
        that it has not been taken.
        """

        if not self.id:
            is_unique = False
            while not is_unique:
                id = generate_random_id()
                is_unique = not self.__class__.objects.filter(id=id).exists()

            self.id = id

        super(RandomIDModel, self).save(*args, **kwargs)