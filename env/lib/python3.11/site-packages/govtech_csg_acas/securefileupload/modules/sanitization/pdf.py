import hashlib
import logging

from ...vendor.pdfid import pdfid
from govtech_csg_acas.securefileupload import logger

def sanitize_file(file):
    '''sanitize pdf file using pdfid'''
    logger.debug("[Sanitizer module] - Starting application sanitization")

    try:
        options = pdfid.get_fake_options()
        options.disarm = True
        options.return_disarmed_buffer = True
        logging.getLogger('PDFiD').setLevel(logging.WARNING)

        disarmed_pdf_dict = pdfid.PDFiDMain(
            ["pdffile"], options, [file.content])

        # check whether the file content was modified
        md5_hash = hashlib.sha256()
        md5_hash.update(disarmed_pdf_dict["buffers"][0])
        if md5_hash.hexdigest() != file.basic_information.sha256:
            file.sanitization_results.disarmed_pdf = True

        file.content = disarmed_pdf_dict["buffers"][0]

    except Exception as e:
        logger.error(
            "[Sanitizer module - PDF] - Error sanitizing PDF to generate a disarmed PDF file: {}".format(e))
